<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Estoque Enterprise v6.1 - Backup JSON</title>
    <style>
        :root {
            --cor-fundo: #f0f2f5;
            --cor-primaria: #1a365d;
            --cor-destaque: #3182ce;
            --cor-perigo: #e53e3e;
            --cor-sucesso: #38a169;
            --cor-alerta: #d69e2e;
            --cor-texto: #2d3748;
            --cor-borda: #e2e8f0;
            --cor-card: white;
        }
        [data-theme="dark"] {
            --cor-fundo: #1a202c;
            --cor-primaria: #2c5282;
            --cor-destaque: #63b3ed;
            --cor-perigo: #f56565;
            --cor-sucesso: #68d391;
            --cor-alerta: #f6e05e;
            --cor-texto: #e2e8f0;
            --cor-borda: #4a5568;
            --cor-card: #2d3748;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #tela-login {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--cor-primaria);
            display: flex; justify-content: center; align-items: center;
            z-index: 9000;
        }
        .card-login {
            background: var(--cor-card); padding: 40px; border-radius: 15px;
            width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
        }
        header {
            background: var(--cor-card); padding: 10px 30px; display: flex;
            justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        .container-principal { padding: 20px; flex: 1; }
        .secao-setores {
            margin-bottom: 30px;
            padding: 15px;
            background: var(--cor-borda);
            border-radius: 15px;
        }
        .quadro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        .coluna {
            background: var(--cor-card);
            border-radius: 12px;
            display: flex; flex-direction: column;
            height: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        .coluna.bloqueada { opacity: 0.7; border-color: var(--cor-perigo); }
        .coluna.fixa { border-color: var(--cor-destaque); }
        .coluna.arrastando { opacity: 0.6; }
        .coluna.drag-over { border: 2px dashed var(--cor-destaque); }
        .cabecalho-coluna {
            padding: 15px;
            border-bottom: 1px solid var(--cor-borda);
            display: flex; justify-content: space-between; align-items: center;
            cursor: grab;
            background: var(--cor-borda);
        }
        .container-itens {
            padding: 12px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .paineis-topo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card-controle {
            background: var(--cor-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .btn-primario { background: var(--cor-destaque); color: white; }
        .btn-perigo { background: var(--cor-perigo); color: white; }
        .btn-sucesso { background: var(--cor-sucesso); color: white; }
        .btn-alerta { background: var(--cor-alerta); color: white; }
        input, select {
            padding: 8px;
            border: 1px solid var(--cor-borda);
            border-radius: 6px;
            background: var(--cor-card);
            color: var(--cor-texto);
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 8000;
            justify-content: center;
            align-items: center;
        }
        .conteudo-modal {
            background: var(--cor-card);
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }
        .hidden { display: none !important; }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .cartao {
            background: rgba(255,255,255,0.08);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--cor-destaque);
            border: 1px solid var(--cor-borda);
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="tela-login">
        <div class="card-login">
            <h2 style="text-align:center; margin:0 0 25px;">üöÄ Enterprise Login v6.1</h2>
            <div style="display:flex; flex-direction:column; gap:15px;">
                <input type="text" id="login-user" placeholder="Usu√°rio" autocomplete="username">
                <input type="password" id="login-pass" placeholder="Senha" autocomplete="current-password">
                <button onclick="realizarLogin()" class="btn-primario" style="padding:12px;">Entrar</button>
                <button onclick="resetEmergencia()" style="background:none; border:none; color:#aaa; font-size:0.8rem; cursor:pointer; text-align:center;">
                    Esqueci a senha / Reset de f√°brica
                </button>
            </div>
        </div>
    </div>
    <!-- Cabe√ßalho -->
    <header>
        <div style="display:flex; align-items:center; gap:12px;">
            <span style="font-size:1.8rem;">üè¢</span>
            <h2 style="margin:0; font-size:1.3rem;">Enterprise Stock v6.1</h2>
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <span id="user-display" style="font-weight:700;"></span>
            <button id="btn-theme-toggle" onclick="toggleTheme()" title="Alternar tema" style="background:none; border:none; font-size:1.4rem; cursor:pointer;">üåô</button>
            <button onclick="realizarLogout()" style="background:none; color:var(--cor-perigo); border:none; cursor:pointer;">Sair</button>
        </div>
    </header>
    <div class="container-principal">
        <!-- Pain√©is Admin -->
        <div id="paineis-admin" class="paineis-topo hidden">
            <div class="card-controle">
                <h3>üì¶ Entrada de Itens</h3>
                <input type="text" id="busca-estoque" placeholder="Nome do item..." style="width:100%; margin-bottom:10px;">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="qtd-entrada" value="1" min="1" style="width:80px;">
                    <button onclick="adicionarItemEstoque()" class="btn-primario" style="flex:1;">Adicionar/Atualizar</button>
                </div>
            </div>
            <div class="card-controle" id="painel-usuarios">
                <h3>üë• Novo Usu√°rio</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <input type="text" id="cad-user" placeholder="Login">
                    <input type="password" id="cad-pass" placeholder="Senha">
                    <select id="cad-tipo">
                        <option value="setor">Operador</option>
                        <option value="almoxarifado">Almoxarifado</option>
                        <option value="admin">Admin</option>
                    </select>
                    <select id="cad-setor"><option value="">Sem Setor</option></select>
                </div>
                <button onclick="criarUsuario()" class="btn-sucesso" style="width:100%; margin-top:12px;">Cadastrar</button>
            </div>
            <div class="card-controle">
                <h3>‚öôÔ∏è Configura√ß√µes</h3>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button onclick="abrirModalSetor()" class="btn-alerta">Novo Setor</button>
                    <button onclick="exportarBackup()" class="btn-primario">Backup (JSON)</button>
                    <button onclick="document.getElementById('input-restore').click()" class="btn-sucesso">Restaurar Backup</button>
                    <input type="file" id="input-restore" class="hidden" onchange="importarBackup(this.files[0])" accept=".json">
                    <button onclick="exportarRelatorioCSV()" class="btn-primario">Exportar CSV</button>
                    <button onclick="resetarSistema()" class="btn-perigo">Reset Total</button>
                </div>
            </div>
        </div>
        <!-- Busca global para operadores -->
        <div id="painel-busca-setor" class="card-controle hidden">
            <h3>üîç Buscar no Estoque Central</h3>
            <input type="text" id="busca-global-estoque" placeholder="Digite para buscar..." style="width:100%;" oninput="buscarNoEstoqueDebounced(this.value)">
            <div id="resultados-busca-estoque" style="margin-top:15px; display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:12px;"></div>
        </div>
        <!-- Quadros -->
        <div id="secao-estoque-solicitacoes" class="secao-setores hidden">
            <h2>üì¶ Gest√£o Central e Solicita√ß√µes</h2>
            <div class="quadro-grid" id="quadro-gestao"></div>
        </div>
        <div id="secao-demais-setores" class="secao-setores">
            <h2 id="titulo-secao-setores">Setores Operacionais</h2>
            <div class="quadro-grid" id="quadro-setores"></div>
        </div>
    </div>
    <!-- Modais (ainda placeholders - implemente quando necess√°rio) -->
    <div id="modal-setor" class="modal"><div class="conteudo-modal">Modal Novo/Editar Setor (implementar)</div></div>
    <div id="modal-transferir" class="modal"><div class="conteudo-modal">Modal Transfer√™ncia (implementar)</div></div>
    <div id="modal-solicitar" class="modal"><div class="conteudo-modal">Modal Solicita√ß√£o (implementar)</div></div>

    <div id="container-toast" style="position:fixed; bottom:20px; right:20px; z-index:9999;"></div>

<script>
// ==================== CONFIGURA√á√ÉO INICIAL ====================
let db = {
    usuarios: [{
        id: 'u1',
        nome: 'admin',
        senha: '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', // hash de "admin"
        tipo: 'admin',
        setorId: '',
        ip: '-',
        acesso: '-',
        bloqueado: false,
        primeiroAcesso: true
    }],
    setores: [{ id: 'estoque', nome: 'Estoque Central', emoji: 'üì¶', cor: '#f8fafc', fixa: true, ordem: 0, bloqueado: false }],
    itens: [],
    logs: []
};
let userLogado = null;

// ==================== UTILIT√ÅRIOS ====================
async function hash(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
}

const currentNetworkInfo = (function(){
    const h = window.location.hostname;
    if (h === 'localhost' || h === '127.0.0.1') return 'localhost (127.0.0.1)';
    if (/^(\d{1,3}\.){3}\d{1,3}$/.test(h)) return h + ' (rede local)';
    return h + ' (interno)';
})();

function salvar() {
    localStorage.setItem('enterprise_stock_v6_1', JSON.stringify(db));
}

function registrarLog(msg) {
    db.logs.unshift(`[${new Date().toLocaleString('pt-BR')}] ${userLogado?.nome||'Sistema'} (${currentNetworkInfo}): ${msg}`);
    if (db.logs.length > 300) db.logs.pop();
    salvar();
}

// ==================== BACKUP JSON ====================
function exportarBackup() {
    const dataStr = JSON.stringify(db, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `backup_estoque_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    toast("Backup JSON gerado com sucesso!", "sucesso");
}

async function importarBackup(file) {
    if (!file) return;
    try {
        const text = await file.text();
        const dadosImportados = JSON.parse(text);

        // Valida√ß√£o b√°sica (pode ser expandida depois)
        if (!dadosImportados.usuarios || !dadosImportados.setores || !dadosImportados.itens) {
            throw new Error("Arquivo inv√°lido - estrutura de dados n√£o reconhecida");
        }

        if (confirm("ATEN√á√ÉO: Isso substituir√° TODOS os dados atuais. Deseja continuar?")) {
            db = dadosImportados;
            salvar();
            toast("Backup restaurado com sucesso! Recarregando sistema...", "sucesso");
            setTimeout(() => location.reload(), 1500);
        }
    } catch (err) {
        toast("Erro ao importar backup: " + err.message, "erro");
        console.error(err);
    }
}

// ==================== TEMA CLARO/ESCURO ====================
function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || 'light';
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    document.getElementById('btn-theme-toggle').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('theme', next);
}

(function initTheme(){
    const saved = localStorage.getItem('theme');
    if (saved) {
        document.documentElement.setAttribute('data-theme', saved);
        document.getElementById('btn-theme-toggle').textContent = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    } else if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('btn-theme-toggle').textContent = '‚òÄÔ∏è';
    }
})();

// ==================== LOGIN ====================
async function realizarLogin() {
    const usuario = document.getElementById('login-user').value.trim();
    const senha = document.getElementById('login-pass').value;
    if (!usuario || !senha) {
        toast("Preencha usu√°rio e senha", "erro");
        return;
    }
    const senhaHash = await hash(senha);
    const encontrado = db.usuarios.find(u => u.nome === usuario && u.senha === senhaHash);
    if (!encontrado) {
        toast("Usu√°rio ou senha inv√°lidos", "erro");
        return;
    }
    if (encontrado.bloqueado) {
        toast("Usu√°rio bloqueado pelo administrador", "erro");
        return;
    }
    userLogado = encontrado;
    encontrado.acesso = new Date().toLocaleString('pt-BR');
    encontrado.ip = currentNetworkInfo;
    document.getElementById('tela-login').classList.add('hidden');
    registrarLog("Login realizado com sucesso");
    if (encontrado.primeiroAcesso) {
        const novaSenha = prompt("Primeiro acesso! Digite sua nova senha (m√≠nimo 4 caracteres):");
        if (novaSenha && novaSenha.length >= 4) {
            encontrado.senha = await hash(novaSenha);
            encontrado.primeiroAcesso = false;
            toast("Senha atualizada com sucesso!");
        } else {
            toast("Senha n√£o alterada (m√≠nimo 4 caracteres)", "erro");
        }
    }
    salvar();
    atualizarInterface();
}

function realizarLogout() {
    registrarLog("Logout realizado");
    userLogado = null;
    document.getElementById('tela-login').classList.remove('hidden');
    document.getElementById('login-user').value = '';
    document.getElementById('login-pass').value = '';
}

function resetEmergencia() {
    if (confirm("Resetar TODO o sistema para padr√£o de f√°brica?\nIsso apagar√° todos os dados!")) {
        localStorage.clear();
        location.reload();
    }
}

// ==================== INTERFACE ====================
function atualizarInterface() {
    if (!userLogado) return;
    document.getElementById('user-display').textContent = `${userLogado.nome} (${userLogado.tipo})`;
    const isAdminOuAlmox = userLogado.tipo === 'admin' || userLogado.tipo === 'almoxarifado';
    document.getElementById('paineis-admin').classList.toggle('hidden', !isAdminOuAlmox);
    document.getElementById('painel-busca-setor').classList.toggle('hidden', isAdminOuAlmox);
    document.getElementById('secao-estoque-solicitacoes').classList.toggle('hidden', !isAdminOuAlmox);
    atualizarQuadro();
}

// ==================== TOAST ====================
function toast(msg, tipo = 'sucesso') {
    const el = document.createElement('div');
    el.className = 'toast';
    el.style.background = tipo === 'sucesso' ? 'var(--cor-sucesso)' : 'var(--cor-perigo)';
    el.textContent = msg;
    document.getElementById('container-toast').appendChild(el);
    setTimeout(() => el.remove(), 3500);
}

// ==================== CARGA INICIAL ====================
document.addEventListener('DOMContentLoaded', () => {
    const salvo = localStorage.getItem('enterprise_stock_v6_1');
    if (salvo) db = JSON.parse(salvo);
    atualizarInterface();
});

// ==================== FUN√á√ïES B√ÅSICAS (exemplo) ====================
function adicionarItemEstoque() {
    const nome = document.getElementById('busca-estoque').value.trim();
    const qtd = parseInt(document.getElementById('qtd-entrada').value) || 1;
    if (!nome) return toast("Digite o nome do item", "erro");
    let item = db.itens.find(i => i.setorId === 'estoque' && i.nome.toLowerCase() === nome.toLowerCase());
    if (item) {
        item.qtd += qtd;
        toast(`+${qtd} adicionado a ${nome}`, "sucesso");
    } else {
        db.itens.push({ id: Date.now().toString(), nome, qtd, setorId: 'estoque' });
        toast(`Novo item criado: ${nome} (${qtd})`, "sucesso");
    }
    salvar();
    atualizarQuadro();
}

// Placeholder para as outras fun√ß√µes (drag & drop, CSV, quadros, etc.)
function atualizarQuadro() {
    // Implementar quando quiser adicionar os quadros/setores/itens
    console.log("Quadro atualizado (placeholder)");
}

function exportarRelatorioCSV() {
    toast("Fun√ß√£o CSV ainda n√£o implementada nesta vers√£o m√≠nima", "erro");
}

function abrirModalSetor() {
    toast("Modal de setor ainda n√£o implementado", "erro");
}

function criarUsuario() {
    toast("Cria√ß√£o de usu√°rio ainda n√£o implementada nesta vers√£o m√≠nima", "erro");
}
</script>
</body>
</html>