<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Estoque Corporativo v4.0</title>
    <style>
        :root {
            --cor-fundo: #f0f2f5;
            --cor-primaria: #1a365d;
            --cor-destaque: #3182ce;
            --cor-perigo: #e53e3e;
            --cor-sucesso: #38a169;
            --cor-alerta: #d69e2e;
            --cor-texto: #2d3748;
            --cor-borda: #e2e8f0;
            --cor-admin: #805ad5;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Tela de Login */
        #tela-login {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--cor-primaria);
            display: flex; justify-content: center; align-items: center;
            z-index: 3000;
        }

        .card-login {
            background: white; padding: 40px; border-radius: 15px;
            width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
        }

        /* Layout Principal */
        header {
            background: white; padding: 15px 30px; display: flex;
            justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .user-info { display: flex; align-items: center; gap: 15px; font-weight: 600; }

        main { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; gap: 20px; }

        /* Containers de Controle */
        .painel-admin {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 10px;
        }

        .card-controle {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-top: 4px solid var(--cor-destaque);
        }

        .form-grid { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: flex-end; }

        /* Quadro de Setores */
        .quadro {
            display: flex; overflow-x: auto; gap: 20px; padding-bottom: 20px;
            flex-grow: 1; align-items: flex-start;
        }

        .coluna {
            background-color: #fff; border-radius: 12px; min-width: 320px; max-width: 320px;
            display: flex; flex-direction: column; max-height: 75vh;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid transparent; transition: all 0.2s;
            flex-shrink: 0;
        }

        .coluna.arrastando-sobre { border-color: var(--cor-destaque); transform: scale(1.01); }

        .cabecalho-coluna {
            padding: 15px; border-bottom: 1px solid #edf2f7;
            display: flex; justify-content: space-between; align-items: center;
            cursor: grab;
        }

        .cabecalho-coluna h3 { margin: 0; font-size: 1rem; display: flex; align-items: center; gap: 8px; }

        .container-itens { padding: 12px; overflow-y: auto; flex-grow: 1; min-height: 100px; }

        /* Cart√µes de Itens */
        .cartao {
            background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 12px;
            border-left: 4px solid var(--cor-destaque); transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .cartao.solicitacao { border-left-color: var(--cor-alerta); background: #fffaf0; }
        .cartao.zerado { opacity: 0.6; border-left-color: #cbd5e0; }

        .info-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .nome-item { font-weight: 700; font-size: 0.95rem; }
        .qtd-badge { background: white; padding: 2px 10px; border-radius: 20px; font-size: 0.85rem; border: 1px solid #e2e8f0; }

        .acoes-item { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

        /* Bot√µes */
        button {
            padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
            font-weight: 600; transition: all 0.2s; font-size: 0.85rem;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primario { background: var(--cor-destaque); color: white; }
        .btn-sucesso { background: var(--cor-sucesso); color: white; }
        .btn-perigo { background: var(--cor-perigo); color: white; }
        .btn-alerta { background: var(--cor-alerta); color: white; }

        /* Modais */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 4000; justify-content: center; align-items: center;
        }
        .conteudo-modal { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; }

        /* Toasts */
        #container-toast { position: fixed; bottom: 20px; right: 20px; z-index: 5000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 25px; border-radius: 10px; color: white; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        /* Utilit√°rios */
        .campo { display: flex; flex-direction: column; gap: 5px; margin-bottom: 15px; }
        label { font-size: 0.8rem; font-weight: 700; color: #4a5568; }
        input, select { padding: 10px; border: 1px solid var(--cor-borda); border-radius: 8px; outline: none; }
        input:focus { border-color: var(--cor-destaque); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Tela de Login -->
    <div id="tela-login">
        <div class="card-login">
            <h2 style="text-align: center; margin-bottom: 30px;">üîê Acesso ao Sistema</h2>
            <div class="campo">
                <label>Usu√°rio</label>
                <input type="text" id="login-user" placeholder="admin">
            </div>
            <div class="campo">
                <label>Senha</label>
                <input type="password" id="login-pass" placeholder="admin">
            </div>
            <button onclick="realizarLogin()" class="btn-primario" style="width: 100%; padding: 12px;">Entrar</button>
        </div>
    </div>

    <!-- Modal Troca de Senha Obrigat√≥ria -->
    <div id="modal-primeiro-acesso" class="modal">
        <div class="conteudo-modal">
            <h3>‚ö†Ô∏è Primeiro Acesso Detectado</h3>
            <p>Por seguran√ßa, voc√™ deve alterar seu nome de usu√°rio e senha.</p>
            <div class="campo">
                <label>Novo Usu√°rio</label>
                <input type="text" id="novo-user">
            </div>
            <div class="campo">
                <label>Nova Senha</label>
                <input type="password" id="nova-pass">
            </div>
            <button onclick="salvarPrimeiroAcesso()" class="btn-primario" style="width: 100%;">Salvar e Continuar</button>
        </div>
    </div>

    <!-- Interface Principal -->
    <header>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.5rem;">üì¶</span>
            <h2 style="margin: 0;">Estoque Corporativo</h2>
        </div>
        <div class="user-info">
            <span id="display-user-role" style="background: #edf2f7; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem;"></span>
            <span id="display-user-name"></span>
            <button onclick="realizarLogout()" style="background: none; color: var(--cor-perigo); padding: 0;">Sair</button>
        </div>
    </header>

    <main>
        <!-- Painel Administrativo (Vis√≠vel apenas para Admin/Almoxarifado) -->
        <div id="painel-admin" class="painel-admin hidden">
            <div class="card-controle">
                <h3>‚ûï Entrada de Itens</h3>
                <div class="form-grid">
                    <div class="campo" style="margin:0">
                        <label>Pesquisar / Adicionar</label>
                        <input type="text" id="busca-estoque" placeholder="Digite para filtrar..." oninput="filtrarEstoque(this.value)">
                    </div>
                    <div class="campo" style="margin:0; width: 70px;">
                        <label>Qtd</label>
                        <input type="number" id="qtd-entrada" value="1" min="1">
                    </div>
                </div>
                <button onclick="adicionarItemEstoque()" class="btn-primario" style="margin-top: 15px; width: 100%;">Adicionar ao Estoque</button>
            </div>

            <div class="card-controle" id="card-gestao-usuarios">
                <h3>üë• Gest√£o de Usu√°rios</h3>
                <div class="form-grid">
                    <input type="text" id="user-nome" placeholder="Nome">
                    <input type="password" id="user-senha" placeholder="Senha">
                    <select id="user-tipo">
                        <option value="almoxarifado">Almoxarifado</option>
                        <option value="admin">Administrador</option>
                        <option value="setor">Operador de Setor</option>
                    </select>
                    <select id="user-setor-alvo">
                        <option value="">Nenhum Setor</option>
                    </select>
                </div>
                <button onclick="criarUsuario()" class="btn-primario" style="margin-top: 15px; width: 100%;">Criar Usu√°rio</button>
            </div>

            <div class="card-controle" id="card-gestao-setores">
                <h3>üè¢ Novos Setores</h3>
                <div class="form-grid">
                    <input type="text" id="setor-nome" placeholder="Nome (ex: TI)">
                    <input type="text" id="setor-emoji" placeholder="Emoji (ex: üíª)" style="width: 50px;">
                    <input type="color" id="setor-cor" value="#ffffff">
                </div>
                <button onclick="criarSetor()" class="btn-alerta" style="margin-top: 15px; width: 100%;">Criar Setor</button>
            </div>
        </div>

        <div class="quadro" id="quadro"></div>
    </main>

    <!-- Modal Solicita√ß√£o -->
    <div id="modal-solicitar" class="modal">
        <div class="conteudo-modal">
            <h3>üì¶ Solicitar Reposi√ß√£o</h3>
            <p id="txt-solicitar-item"></p>
            <div class="campo">
                <label>Quantidade Desejada</label>
                <input type="number" id="qtd-solicitada" min="1" value="1">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="fecharModalSolicitar()" style="background: #cbd5e0;">Cancelar</button>
                <button onclick="confirmarSolicitacao()" class="btn-primario">Enviar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal Transfer√™ncia (Almoxarifado) -->
    <div id="modal-transferir" class="modal">
        <div class="conteudo-modal">
            <h3>üöö Enviar para Setor</h3>
            <p id="txt-transferir-info"></p>
            <div class="campo">
                <label>Quantidade a Enviar</label>
                <input type="number" id="qtd-transferir" min="1" value="1">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="fecharModalTransferir()" style="background: #cbd5e0;">Cancelar</button>
                <button onclick="confirmarTransferencia()" class="btn-sucesso">Confirmar Envio</button>
            </div>
        </div>
    </div>

    <div id="container-toast"></div>

    <script>
        // --- Estado Inicial ---
        let db = {
            usuarios: [
                { id: 'u1', nome: 'admin', senha: 'admin', tipo: 'admin', primeiroAcesso: true }
            ],
            setores: [
                { id: 'estoque', nome: 'Estoque Central', emoji: 'üì¶', cor: '#f8fafc', ordem: 0 }
            ],
            itens: [],
            solicitacoes: [] // Itens em tr√¢nsito/pedido
        };

        let usuarioLogado = null;
        let itemEmAcao = null;
        let setorDestinoAcao = null;

        // --- Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
            const salvo = localStorage.getItem('estoque_corp_v4');
            if (salvo) db = JSON.parse(salvo);
            atualizarInterface();
        });

        function salvarDB() { localStorage.setItem('estoque_corp_v4', JSON.stringify(db)); }

        // --- Autentica√ß√£o ---
        function realizarLogin() {
            const nome = document.getElementById('login-user').value;
            const senha = document.getElementById('login-pass').value;
            const user = db.usuarios.find(u => u.nome === nome && u.senha === senha);

            if (user) {
                usuarioLogado = user;
                document.getElementById('tela-login').classList.add('hidden');
                if (user.primeiroAcesso) {
                    document.getElementById('modal-primeiro-acesso').style.display = 'flex';
                } else {
                    mostrarToast(`Bem-vindo, ${user.nome}!`);
                    atualizarInterface();
                }
            } else {
                mostrarToast("Usu√°rio ou senha incorretos!", "erro");
            }
        }

        function salvarPrimeiroAcesso() {
            const novoNome = document.getElementById('novo-user').value.trim();
            const novaSenha = document.getElementById('nova-pass').value.trim();
            if (!novoNome || !novaSenha) return mostrarToast("Preencha os campos!", "erro");

            usuarioLogado.nome = novoNome;
            usuarioLogado.senha = novaSenha;
            usuarioLogado.primeiroAcesso = false;
            salvarDB();
            document.getElementById('modal-primeiro-acesso').style.display = 'none';
            mostrarToast("Dados atualizados com sucesso!");
            atualizarInterface();
        }

        function realizarLogout() {
            usuarioLogado = null;
            document.getElementById('tela-login').classList.remove('hidden');
            document.getElementById('login-user').value = '';
            document.getElementById('login-pass').value = '';
        }

        // --- Gest√£o de Interface ---
        function atualizarInterface() {
            if (!usuarioLogado) return;

            document.getElementById('display-user-name').innerText = usuarioLogado.nome;
            document.getElementById('display-user-role').innerText = usuarioLogado.tipo.toUpperCase();

            // Visibilidade do Painel Admin
            const painel = document.getElementById('painel-admin');
            if (usuarioLogado.tipo === 'admin' || usuarioLogado.tipo === 'almoxarifado') {
                painel.classList.remove('hidden');
                document.getElementById('card-gestao-usuarios').classList.toggle('hidden', usuarioLogado.tipo !== 'admin');
            } else {
                painel.classList.add('hidden');
            }

            // Atualizar Selects de Setores
            const selectSetorUser = document.getElementById('user-setor-alvo');
            selectSetorUser.innerHTML = '<option value="">Nenhum Setor</option>' +
                db.setores.filter(s => s.id !== 'estoque' && s.id !== 'solicitacao').map(s => `<option value="${s.id}">${s.nome}</option>`).join('');

            atualizarQuadro();
        }

        function atualizarQuadro() {
            const quadro = document.getElementById('quadro');
            quadro.innerHTML = '';

            // Ordenar setores
            const setoresOrdenados = [...db.setores].sort((a, b) => a.ordem - b.ordem);

            // Inserir setor de "Solicita√ß√£o" se houver itens nele
            const itensSolicitacao = db.itens.filter(i => i.setorId === 'solicitacao');
            if (itensSolicitacao.length > 0) {
                const idxEstoque = setoresOrdenados.findIndex(s => s.id === 'estoque');
                setoresOrdenados.splice(idxEstoque + 1, 0, { id: 'solicitacao', nome: 'Solicita√ß√µes', emoji: 'üîî', cor: '#fffaf0' });
            }

            setoresOrdenados.forEach(setor => {
                const col = document.createElement('div');
                col.className = 'coluna';
                col.style.backgroundColor = setor.cor;
                col.id = `col-${setor.id}`;

                // Drag and Drop de Setores (Apenas Admin)
                if (usuarioLogado.tipo === 'admin' && setor.id !== 'solicitacao') {
                    col.draggable = true;
                    col.ondragstart = (e) => { e.dataTransfer.setData('setorId', setor.id); };
                    col.ondragover = (e) => { e.preventDefault(); col.classList.add('arrastando-sobre'); };
                    col.ondragleave = () => col.classList.remove('arrastando-sobre');
                    col.ondrop = (e) => reordenarSetores(e, setor.id);
                }

                col.innerHTML = `
                    <div class="cabecalho-coluna">
                        <h3>${setor.emoji} ${setor.nome}</h3>
                        ${(usuarioLogado.tipo === 'admin' && setor.id !== 'estoque' && setor.id !== 'solicitacao') ? `<button onclick="removerSetor('${setor.id}')" style="color:var(--cor-perigo); background:none;">√ó</button>` : ''}
                    </div>
                    <div class="container-itens" ondragover="event.preventDefault()" ondrop="tratarDropItem(event, '${setor.id}')"></div>
                `;

                const container = col.querySelector('.container-itens');
                const itens = db.itens.filter(i => i.setorId === setor.id);

                itens.forEach(item => container.appendChild(criarCartaoItem(item)));
                quadro.appendChild(col);
            });
        }

        function criarCartaoItem(item) {
            const cartao = document.createElement('div');
            cartao.className = `cartao ${item.setorId === 'solicitacao' ? 'solicitacao' : ''} ${item.qtd === 0 ? 'zerado' : ''}`;
            cartao.id = `item-${item.id}`;

            // Permiss√µes de Drag
            const podeMover = (usuarioLogado.tipo === 'admin' || usuarioLogado.tipo === 'almoxarifado') && item.setorId === 'estoque' && item.qtd > 0;
            cartao.draggable = podeMover;
            if (podeMover) {
                cartao.ondragstart = (e) => { e.dataTransfer.setData('itemId', item.id); };
            }

            let acoes = '';

            // A√ß√µes por Tipo de Usu√°rio e Setor
            if (item.setorId === 'estoque') {
                if (usuarioLogado.tipo === 'admin' || usuarioLogado.tipo === 'almoxarifado') {
                    acoes += `<button class="btn-sucesso" onclick="alterarQtd('${item.id}', 1)">+1</button>`;
                    if (item.qtd === 0) acoes += `<button class="btn-perigo" onclick="excluirItem('${item.id}')">Excluir</button>`;
                }
            } else if (item.setorId === 'solicitacao') {
                if (usuarioLogado.tipo === 'admin' || usuarioLogado.tipo === 'almoxarifado') {
                    acoes += `<button class="btn-sucesso" onclick="atenderSolicitacao('${item.id}')">Atender</button>`;
                    acoes += `<button class="btn-perigo" onclick="excluirItem('${item.id}')">Recusar</button>`;
                }
                acoes += `<div style="font-size:0.7rem; color:var(--cor-alerta); width:100%; margin-top:5px;">Destino: ${db.setores.find(s => s.id === item.setorDestino)?.nome}</div>`;
            } else {
                // Setores Operacionais
                const eDonoDoSetor = usuarioLogado.tipo === 'admin' || usuarioLogado.setorId === item.setorId;
                if (eDonoDoSetor && item.qtd > 0) {
                    acoes += `<button class="btn-primario" onclick="utilizarItem('${item.id}')">Utilizar</button>`;
                }
                if (item.qtd === 0) {
                    acoes += `<button class="btn-alerta" onclick="abrirSolicitacao('${item.id}')">Solicitar +</button>`;
                    if (usuarioLogado.tipo === 'admin') acoes += `<button class="btn-perigo" onclick="excluirItem('${item.id}')">Limpar</button>`;
                }
            }

            cartao.innerHTML = `
                <div class="info-item">
                    <span class="nome-item">${item.nome}</span>
                    <span class="qtd-badge">${item.qtd}</span>
                </div>
                <div class="acoes-item">${acoes}</div>
            `;
            return cartao;
        }

        // --- L√≥gica de Neg√≥cio ---
        function adicionarItemEstoque() {
            const nome = document.getElementById('busca-estoque').value.trim();
            const qtd = parseInt(document.getElementById('qtd-entrada').value);
            if (!nome || qtd < 1) return mostrarToast("Dados inv√°lidos", "erro");

            const existente = db.itens.find(i => i.nome.toLowerCase() === nome.toLowerCase() && i.setorId === 'estoque');
            if (existente) {
                existente.qtd += qtd;
            } else {
                db.itens.push({ id: Date.now().toString(), nome, qtd, setorId: 'estoque', dataAtu: Date.now() });
            }
            salvarDB();
            atualizarInterface();
            document.getElementById('busca-estoque').value = '';
            mostrarToast("Estoque atualizado!");
        }

        function filtrarEstoque(val) {
            const itens = document.querySelectorAll('#col-estoque .cartao');
            itens.forEach(card => {
                const nome = card.querySelector('.nome-item').innerText.toLowerCase();
                if (nome.includes(val.toLowerCase())) {
                    card.classList.remove('hidden');
                    if (nome.startsWith(val.toLowerCase())) card.parentElement.prepend(card);
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        function utilizarItem(id) {
            const item = db.itens.find(i => i.id === id);
            if (item && item.qtd > 0) {
                item.qtd--;
                salvarDB();
                atualizarQuadro();
                mostrarToast("Item utilizado.");
            }
        }

        function abrirSolicitacao(id) {
            const item = db.itens.find(i => i.id === id);
            itemEmAcao = item;
            document.getElementById('txt-solicitar-item').innerText = `Solicitar reposi√ß√£o de: ${item.nome}`;
            document.getElementById('modal-solicitar').style.display = 'flex';
        }

        function confirmarSolicitacao() {
            const qtd = parseInt(document.getElementById('qtd-solicitada').value);
            if (qtd < 1) return;

            // Criar item no setor de solicita√ß√£o
            db.itens.push({
                id: 'sol-' + Date.now(),
                nome: itemEmAcao.nome,
                qtd: qtd,
                setorId: 'solicitacao',
                setorDestino: itemEmAcao.setorId,
                dataAtu: Date.now()
            });

            salvarDB();
            fecharModalSolicitar();
            atualizarQuadro();
            mostrarToast("Solicita√ß√£o enviada ao Almoxarifado!");
        }

        function atenderSolicitacao(id) {
            const sol = db.itens.find(i => i.id === id);
            const estoque = db.itens.find(i => i.nome.toLowerCase() === sol.nome.toLowerCase() && i.setorId === 'estoque');

            if (!estoque || estoque.qtd < sol.qtd) {
                return mostrarToast("Estoque insuficiente para atender total!", "erro");
            }

            estoque.qtd -= sol.qtd;
            const destino = db.itens.find(i => i.nome.toLowerCase() === sol.nome.toLowerCase() && i.setorId === sol.setorDestino);
            if (destino) destino.qtd += sol.qtd;

            db.itens = db.itens.filter(i => i.id !== id);
            salvarDB();
            atualizarQuadro();
            mostrarToast("Solicita√ß√£o atendida!");
        }

        // --- Drag and Drop ---
        function tratarDropItem(e, setorDestinoId) {
            const itemId = e.dataTransfer.getData('itemId');
            if (!itemId) return;
            const item = db.itens.find(i => i.id === itemId);
            if (setorDestinoId === 'estoque' || setorDestinoId === 'solicitacao') return;

            itemEmAcao = item;
            setorDestinoAcao = setorDestinoId;
            document.getElementById('txt-transferir-info').innerText = `Enviar ${item.nome} para ${db.setores.find(s => s.id === setorDestinoId).nome}`;
            document.getElementById('qtd-transferir').value = 1;
            document.getElementById('qtd-transferir').max = item.qtd;
            document.getElementById('modal-transferir').style.display = 'flex';
        }

        function confirmarTransferencia() {
            const qtd = parseInt(document.getElementById('qtd-transferir').value);
            if (qtd < 1 || qtd > itemEmAcao.qtd) return mostrarToast("Quantidade inv√°lida", "erro");

            itemEmAcao.qtd -= qtd;
            const existente = db.itens.find(i => i.nome.toLowerCase() === itemEmAcao.nome.toLowerCase() && i.setorId === setorDestinoAcao);
            if (existente) {
                existente.qtd += qtd;
            } else {
                db.itens.push({ id: Date.now().toString(), nome: itemEmAcao.nome, qtd: qtd, setorId: setorDestinoAcao, dataAtu: Date.now() });
            }

            salvarDB();
            fecharModalTransferir();
            atualizarQuadro();
            mostrarToast("Item transferido!");
        }

        function reordenarSetores(e, alvoId) {
            e.preventDefault();
            const arrastadoId = e.dataTransfer.getData('setorId');
            if (arrastadoId === alvoId) return;

            const idxArrastado = db.setores.findIndex(s => s.id === arrastadoId);
            const idxAlvo = db.setores.findIndex(s => s.id === alvoId);

            const [removido] = db.setores.splice(idxArrastado, 1);
            db.setores.splice(idxAlvo, 0, removido);

            db.setores.forEach((s, i) => s.ordem = i);
            salvarDB();
            atualizarQuadro();
        }

        // --- Gest√£o de Usu√°rios e Setores ---
        function criarUsuario() {
            const nome = document.getElementById('user-nome').value.trim();
            const senha = document.getElementById('user-senha').value.trim();
            const tipo = document.getElementById('user-tipo').value;
            const setorId = document.getElementById('user-setor-alvo').value;

            if (!nome || !senha) return mostrarToast("Preencha tudo", "erro");
            db.usuarios.push({ id: Date.now().toString(), nome, senha, tipo, setorId, primeiroAcesso: false });
            salvarDB();
            mostrarToast("Usu√°rio criado!");
            document.getElementById('user-nome').value = '';
            document.getElementById('user-senha').value = '';
        }

        function criarSetor() {
            const nome = document.getElementById('setor-nome').value.trim();
            const emoji = document.getElementById('setor-emoji').value.trim() || 'üè¢';
            const cor = document.getElementById('setor-cor').value;

            if (!nome) return;
            db.setores.push({ id: 's' + Date.now(), nome, emoji, cor, ordem: db.setores.length });
            salvarDB();
            atualizarInterface();
            document.getElementById('setor-nome').value = '';
            mostrarToast("Setor criado!");
        }

        function removerSetor(id) {
            const temItens = db.itens.some(i => i.setorId === id && i.qtd > 0);
            if (temItens) return mostrarToast("Setor possui itens ativos!", "erro");
            db.setores = db.setores.filter(s => s.id !== id);
            salvarDB();
            atualizarInterface();
        }

        // --- Auxiliares ---
        function fecharModalSolicitar() { document.getElementById('modal-solicitar').style.display = 'none'; }
        function fecharModalTransferir() { document.getElementById('modal-transferir').style.display = 'none'; }
        function mostrarToast(m, t='sucesso') {
            const c = document.getElementById('container-toast');
            const d = document.createElement('div');
            d.className = 'toast';
            d.style.background = t === 'sucesso' ? '#38a169' : '#e53e3e';
            d.innerText = m;
            c.appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }
        function excluirItem(id) {
            if (confirm("Excluir registro definitivamente?")) {
                db.itens = db.itens.filter(i => i.id !== id);
                salvarDB();
                atualizarQuadro();
            }
        }
        function alterarQtd(id, n) {
            const i = db.itens.find(x => x.id === id);
            i.qtd += n;
            salvarDB();
            atualizarQuadro();
        }
    </script>
</body>
</html>